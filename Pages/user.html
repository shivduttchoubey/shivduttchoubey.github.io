<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LiveMedQR Patient Receiver</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 15px; background-color: #f0f2f5; color: #1c1e21;
            display: flex; flex-direction: column; align-items: center;
        }
        .app-container {
            background-color: #ffffff; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
            width: 100%; max-width: 400px; box-sizing: border-box;
        }
        h2 { color: #1877f2; text-align: center; margin-top: 0; margin-bottom: 20px; font-size: 24px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #606770; font-size: 14px; }
        input[type="text"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 15px;
            border: 1px solid #ccd0d5; border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }
        button {
            background-color: #1877f2; color: white; border: none; padding: 10px 16px;
            text-align: center; display: block; width: 100%; font-size: 16px; font-weight: bold;
            border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease-in-out;
            box-sizing: border-box; margin-bottom: 10px;
        }
        button:hover { background-color: #166fe5; }
        button.secondary { background-color: #e4e6eb; color: #4b4f56; }
        button.secondary:hover { background-color: #d8dade; }
        .status-message { text-align: center; margin-bottom: 15px; padding: 8px; border-radius: 4px; font-size: 14px; }
        .status-disconnected { background-color: #fdf0f0; color: #721c24; border: 1px solid #f5c6cb;}
        .status-connected { background-color: #e7f3ff; color: #004085; border: 1px solid #b8daff; }
        .status-connecting { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .vitals-display { margin-top: 20px; border-top: 1px solid #ccd0d5; padding-top: 15px; }
        .vital-item { background-color: #f7f8fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 15px; display: flex; justify-content: space-between; }
        .vital-item .label { font-weight: 500; color: #333; }
        .vital-item .value { font-weight: bold; color: #1877f2; }
        .log-area { margin-top: 20px; padding: 10px; background-color: #f0f2f5; border: 1px solid #e4e6eb; border-radius: 6px; height: 80px; overflow-y: auto; font-size: 12px; color: #606770; font-family: monospace;}
    </style>
</head>
<body>
    <div class="app-container">
        <h2>LiveMedQR Data Receiver</h2>
        <label for="server-address-input">Bridge Server Address (from QR):</label>
        <input type="text" id="server-address-input" placeholder="ws://192.168.1.X:8765">
        
        <button id="connect-button" onclick="connectWebSocket()">Connect</button>
        <button id="disconnect-button" onclick="disconnectWebSocket()" style="display:none;" class="secondary">Disconnect</button>

        <div id="status-display" class="status-message status-disconnected">Status: Not Connected</div>
        <div id="vitals-output" class="vitals-display" style="display:none;"></div>
        <div id="download-buttons" style="display:none; margin-top:15px;">
            <button class="secondary" onclick="downloadFHIR()">Download FHIR</button>
            <button class="secondary" onclick="downloadHL7()">Download HL7</button>
        </div>
        <div class="log-area" id="log-output">Log: App Initialized.</div>
    </div>

    <script>
        let websocketClient = null;
        let currentVitalsData = null; // To store the latest received vitals

        const serverAddressInput = document.getElementById('server-address-input');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const statusDisplay = document.getElementById('status-display');
        const vitalsOutputDiv = document.getElementById('vitals-output');
        const downloadButtonsDiv = document.getElementById('download-buttons');
        const logOutput = document.getElementById('log-output');

        function logMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `\n${timestamp}: ${message}`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateUIConnected(connected) {
            serverAddressInput.disabled = connected;
            connectButton.style.display = connected ? 'none' : 'block';
            disconnectButton.style.display = connected ? 'block' : 'none';
            if (connected) {
                statusDisplay.textContent = 'Status: Connected';
                statusDisplay.className = 'status-message status-connected';
            } else {
                statusDisplay.textContent = 'Status: Not Connected';
                statusDisplay.className = 'status-message status-disconnected';
                vitalsOutputDiv.style.display = 'none';
                downloadButtonsDiv.style.display = 'none';
            }
        }

        function connectWebSocket() {
            const serverAddress = serverAddressInput.value.trim();
            if (!serverAddress) {
                alert("Please enter the server address.");
                return;
            }
            if (websocketClient && websocketClient.readyState === WebSocket.OPEN) {
                logMessage("Already connected.");
                return;
            }

            logMessage(`Attempting to connect to ${serverAddress}...`);
            statusDisplay.textContent = 'Status: Connecting...';
            statusDisplay.className = 'status-message status-connecting';

            websocketClient = new WebSocket(serverAddress);

            websocketClient.onopen = function(event) {
                logMessage("Successfully connected to WebSocket server.");
                updateUIConnected(true);
            };

            websocketClient.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    currentVitalsData = data; // Store the latest data
                    displayVitals(data);
                    // logMessage(`Data received: HR=${data.heartRate}`); // Too noisy for frequent updates
                } catch (e) {
                    logMessage(`Error parsing message: ${e}`);
                }
            };

            websocketClient.onclose = function(event) {
                logMessage(`WebSocket closed: ${event.code} ${event.reason}`);
                updateUIConnected(false);
                websocketClient = null;
            };

            websocketClient.onerror = function(event) {
                logMessage("WebSocket error occurred.");
                console.error("WebSocket Error: ", event);
                statusDisplay.textContent = 'Status: Connection Error';
                statusDisplay.className = 'status-message status-disconnected';
                // updateUIConnected(false); // onclose will handle this
            };
        }

        function disconnectWebSocket() {
            if (websocketClient) {
                logMessage("Disconnecting...");
                websocketClient.close();
            }
        }

        function displayVitals(vitals) {
            if (!vitals) return;
            vitalsOutputDiv.innerHTML = `
                <div class="vital-item"><span class="label">Heart Rate:</span> <span class="value">${vitals.heartRate} BPM</span></div>
                <div class="vital-item"><span class="label">SpO2:</span> <span class="value">${vitals.spo2} %</span></div>
                <div class="vital-item"><span class="label">Blood Pressure:</span> <span class="value">${vitals.bp} mmHg</span></div>
                <div class="vital-item"><span class="label">Resp. Rate:</span> <span class="value">${vitals.respRate} /min</span></div>
                <div class="vital-item"><span class="label">Temperature:</span> <span class="value">${vitals.temp} Â°C</span></div>
                <div class="vital-item"><span class="label">Timestamp:</span> <span class="value">${new Date(vitals.timestamp).toLocaleString()}</span></div>
            `;
            vitalsOutputDiv.style.display = 'block';
            downloadButtonsDiv.style.display = 'block';
        }

        function _triggerDownload(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
        
        function downloadFHIR() {
            if (!currentVitalsData) {
                alert("No live vitals data received to download.");
                logMessage("FHIR download failed: No current vitals data.");
                return;
            }
            const vitals = currentVitalsData; // Use the latest received data
            const fhirBundle = {
                resourceType: "Bundle", type: "collection", timestamp: vitals.timestamp,
                entry: [
                    { resource: { resourceType: "Observation", status: "final", code: { text: "Heart Rate" }, valueQuantity: { value: vitals.heartRate, unit: "BPM", system: "http://unitsofmeasure.org", code: "/min" }, effectiveDateTime: vitals.timestamp }},
                    { resource: { resourceType: "Observation", status: "final", code: { text: "SpO2" }, valueQuantity: { value: vitals.spo2, unit: "%", system: "http://unitsofmeasure.org", code: "%" }, effectiveDateTime: vitals.timestamp }},
                    { resource: { resourceType: "Observation", status: "final", code: { text: "Blood Pressure" }, component: [ { code: { text: "Systolic" }, valueQuantity: { value: vitals.systolic_bp, unit: "mmHg", system: "http://unitsofmeasure.org", code: "mm[Hg]" } }, { code: { text: "Diastolic" }, valueQuantity: { value: vitals.diastolic_bp, unit: "mmHg", system: "http://unitsofmeasure.org", code: "mm[Hg]" } } ], effectiveDateTime: vitals.timestamp }},
                    { resource: { resourceType: "Observation", status: "final", code: { text: "Respiratory Rate" }, valueQuantity: { value: vitals.respRate, unit: "/min", system: "http://unitsofmeasure.org", code: "/min" }, effectiveDateTime: vitals.timestamp }},
                    { resource: { resourceType: "Observation", status: "final", code: { text: "Body Temperature" }, valueQuantity: { value: vitals.temp, unit: "Cel", system: "http://unitsofmeasure.org", code: "Cel" }, effectiveDateTime: vitals.timestamp }}
                ]
            };
            _triggerDownload(JSON.stringify(fhirBundle, null, 2), `livemedqr_fhir_${new Date().getTime()}.json`, "application/fhir+json");
            logMessage("FHIR data download initiated.");
        }

        function downloadHL7() {
            if (!currentVitalsData) {
                alert("No live vitals data received to download.");
                logMessage("HL7 download failed: No current vitals data.");
                return;
            }
            const vitals = currentVitalsData; // Use the latest received data
            const now = new Date(vitals.timestamp);
            const mshTimestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            const obxTimestamp = mshTimestamp; // For simplicity, use same timestamp for MSH and OBX segments

            const hl7Message = 
`MSH|^~\\&|LiveMedQRBridge|MONITOR_SIM|LiveMedQRWeb|PATIENT_APP|${mshTimestamp}||ORU^R01|MSG${Date.now()}|P|2.5.1
PID|1|||PAT001^Patient^Demo||${now.toISOString().substring(0,10).replace(/-/g,'')}|F
OBR|1|||VITALS^Vital Signs Panel|||${obxTimestamp}
OBX|1|NM|8867-4^HEART RATE^LN|1|${vitals.heartRate}|beats/minute|||||F|||${obxTimestamp}
OBX|2|NM|2708-6^OXYGEN SATURATION^LN|1|${vitals.spo2}|%|||||F|||${obxTimestamp}
OBX|3|NM|8480-6^SYSTOLIC BLOOD PRESSURE^LN|1|${vitals.systolic_bp}|mm[Hg]|||||F|||${obxTimestamp}
OBX|4|NM|8462-4^DIASTOLIC BLOOD PRESSURE^LN|1|${vitals.diastolic_bp}|mm[Hg]|||||F|||${obxTimestamp}
OBX|5|NM|8302-2^RESPIRATORY RATE^LN|1|${vitals.respRate}|/min|||||F|||${obxTimestamp}
OBX|6|NM|8310-5^BODY TEMPERATURE^LN|1|${vitals.temp}|Cel|||||F|||${obxTimestamp}`;
            _triggerDownload(hl7Message, `livemedqr_hl7_${new Date().getTime()}.hl7`, "application/hl7-v2");
            logMessage("HL7 data download initiated.");
        }

        // Attempt to pre-fill server address if developing locally
        // serverAddressInput.value = `ws://${window.location.hostname}:${WEBSOCKET_PORT}`; // This might not work if HTML is file://
        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
             serverAddressInput.value = `ws://${window.location.hostname}:8765`;
        }


    </script>
</body>
</html>
